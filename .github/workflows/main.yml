name: Minecraft Server Loop

on:
  workflow_dispatch:
  push:

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 16
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '16'

      - name: Download PaperMC
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      - name: Accept EULA + server.properties
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" >> server.properties
          echo "server-port=25565" >> server.properties

      - name: Run Minecraft Server (15 min)
        run: |
          java -Xmx16G -Xms12G -jar server.jar --nogui &
          SERVER_PID=$!
          echo "Server started with PID $SERVER_PID"
          sleep 900
          echo "stop" > stop.txt
          kill $SERVER_PID || true
          wait $SERVER_PID || true

      # -------------------- حفظ الملفات --------------------

      - name: Save Worlds
        run: |
          echo "📂 Listing worlds before saving:"
          ls -R world* || true
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: worlds-backup
          path: |
            world
            world_nether
            world_the_end

      - name: Save Plugins
        run: |
          echo "📂 Listing plugins before saving:"
          ls -R plugins || true
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: plugins-backup
          path: plugins

      - name: Save Configs
        run: |
          echo "📂 Listing configs before saving:"
          ls -R *.properties eula.txt || true
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: configs-backup
          path: |
            *.properties
            eula.txt

      # -------------------- Loop --------------------
      - name: Relaunch Workflow
        run: |
          echo "♻️ Relaunching workflow..."
          gh workflow run "Minecraft Server Loop"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
