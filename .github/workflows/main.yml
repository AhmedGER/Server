name: Minecraft Server

on:
  workflow_dispatch: # تشغيل يدوي
  schedule:
    - cron: "0 */6 * * *" # كل 6 ساعات يبدأ سيرفر جديد

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Setup server folder
        run: |
          mkdir -p server/plugins
          cp -r plugins/* server/plugins/ || true
          echo "eula=true" > server/eula.txt
          echo "online-mode=false" >> server/server.properties

      - name: Download PaperMC
        run: |
          cd server
          curl -o paper.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      - name: Run server (5h max)
        run: |
          cd server
          timeout 5h java -Xmx2G -Xms1G -jar paper.jar nogui || true

      - name: List plugins
        run: |
          cd server/plugins
          ls -lh

      - name: Check plugins in logs
        run: |
          cd server
          if [ -f logs/latest.log ]; then
            echo "=== Plugins log lines ==="
            grep -i "Plugin" logs/latest.log || echo "No plugin logs found"
          else
            echo "No logs generated yet."
          fi

      - name: Backup world
        run: |
          rm -rf world-backup
          cp -r server/world world-backup

      - name: Backup plugins
        run: |
          rm -rf plugins-backup
          cp -r server/plugins plugins-backup

      - name: Commit & Push world
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add world-backup
          git commit -m "World backup at $(date)" || echo "No changes in world"
          git push

      - name: Commit & Push plugins
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add plugins-backup
          git commit -m "Plugins backup at $(date)" || echo "No changes in plugins"
          git push
