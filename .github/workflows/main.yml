name: Minecraft Server

on:
  workflow_dispatch:

jobs:
  server-loop:
    runs-on: ubuntu-latest
    timeout-minutes: 3600   # أقصى مدة (مثلاً ساعة) للـ job، ممكن تزودها لو عايز

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java 16
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 16

      - name: Install expect & curl
        run: sudo apt-get update && sudo apt-get install -y expect curl

      - name: Start Infinite Loop
        run: |
          while true
          do
            echo "===== Starting new server cycle ====="

            # تحميل Paper
            curl -o server.jar \
            https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

            # تشغيل السيرفر 15 دقيقة وبعدين stop
            cat > run-server.exp <<'EOF'
            #!/usr/bin/expect -f
            set timeout 900
            spawn java -Xmx4G -Xms2G -jar server.jar --nogui
            expect {
              timeout { send "stop\r" }
            }
            expect eof
            EOF
            chmod +x run-server.exp
            ./run-server.exp

            echo "===== Server stopped, starting backup ====="

            # حفظ worlds
            tar -czf worlds-$(date +%s).tar.gz world world_nether world_the_end || true

            # حفظ plugins
            tar -czf plugins-$(date +%s).tar.gz plugins || true

            # حفظ configs
            tar -czf configs-$(date +%s).tar.gz server.properties bukkit.yml spigot.yml paper.yml logs || true

            # رفع النسخ (Release)
            gh release create "backup-$(date +%s)" \
              worlds-*.tar.gz plugins-*.tar.gz configs-*.tar.gz \
              --generate-notes || true

            echo "===== Cycle finished, restarting loop ====="
          done
