name: Minecraft Server

on:
  workflow_dispatch:   # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  push:                # Ø£Ùˆ Ù„Ùˆ Ø¯ÙØ¹Øª Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ÙŠØ¨Ùˆ

jobs:
  run-server:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Set up Java 16
      uses: actions/setup-java@v3
      with:
        java-version: '16'
        distribution: 'temurin'

    - name: Download Paper Server
      run: |
        mkdir -p server
        cd server
        if [ ! -f server.jar ]; then
          curl -L -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar
        fi

    - name: Prepare Config Files
      run: |
        cd server
        echo "eula=true" > eula.txt

        cat > server.properties <<EOL
        online-mode=false
        motd=Sigma Free Server
        max-players=20
        level-name=world
        enable-command-block=true
        EOL

        mkdir -p plugins
        curl -L -o plugins/playit-minecraft-plugin-1.16.jar https://github.com/playit-cloud/playit-minecraft-plugin/releases/download/v0.1.4/playit-minecraft-plugin-1.16.jar

    - name: Run Minecraft in Loop
      run: |
        cd server
        while true
        do
          echo "ðŸš€ Starting Minecraft Server..."
          timeout 5h java -Xmx16G -Xms12G -jar server.jar --nogui || true

          echo "ðŸ’¾ Saving world and pushing changes..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-save world $(date)" || echo "No changes to commit"
          git push origin main || echo "Push failed (maybe no changes)"

          echo "ðŸ” Restarting server loop..."
        done
