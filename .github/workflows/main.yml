name: Google Drive Service Account Test

on:
  workflow_dispatch:

jobs:
  test-drive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python Google API client
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Create service_account.json
        run: |
          cat > service_account.json <<'JSON'
          {
            "type": "service_account",
            "project_id": "server-472112",
            "private_key_id": "fb0ef84bf8e4d48004641d0a4b5d239e14102ea0",
            "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCmNvhMcLykkaVs\nHX1l3f0EUEcE81PUlXl9Ylgk/l8+XqsKnrtCaHwqYmBRt8qvIyK7OtDctdS36M3c\n45pbdaVveyckyrMie74FLnArURXA+nzbvhfOrene+ILfObMbpDzlc17gw6Bjh03z\nlS1QQNBy89uj4gWEVeP4NrmkU+qLiHpFM++p4GJn62IjoAeW6Kjt8hHshInWI1xO\njdUJhTcKD0vy1VuUk7eJx7FU4mkrbrfiKPbTzNIFW9z2O3pmdDxsTXmnP0LGjhsr\n91yifB+k60OeLyEL9Ze7aLPjlsRoVj8ZHlnlBOmgEeVwQ07tQqhH6q8zscONQ6rP\n+ZBrZEGzAgMBAAECggEAAoaSt53AHuTNAo0xWbjX5aBKXEY7BYDUG5/KWN+iRmx+\nlJGMA/AX2NeySj++oqHEkOTzmxZf8nFlGhZ2jrwKBp+kAKFXb8wJ3MdUm9PlOenD\n5zLn08e4dJEiJzlQo0Zx1wmMbSktBUMv5KPzhFIBSqYs7sDgL0CIWPJArYhXuFg7\nEp94jDx1zK0O7aRVSIBFigXBGbW8RuiQIU9hkr/bZ1lf94o4eriz7d5+9uTeXH+i\nGsNJxcxf6H2pgfh8hK3a8U1Y5I9N4ubqdL3iNrsjX+Sjcrs/RNobeelkGKRfGP6i\nhCy0yQ42ZMFrzqm25M8tgV9FWCyYzWSW6/dYDT2SQQKBgQDkb0tdHLmIbAVgxho4\nCUGZ1sOuTK7q3gG4/WBuaepcVhBcD0+UoIXujVHkh3W5SbCOpeFGDZH1Ds3UG/2X\nKkqpm1wZ74ydOt3dbAi4h6xeaTdNQHfs8vhaMPtbwggRE/rP82hEuzGWGlRywfWf\nVMt4AJsXvb00EVWNPGoHJg7EJQKBgQC6RZokcy+e4+7AibMQbJ1us2SA27JqcDj2\nxcN40CMPYwUN0OiP1Q3nSYckdP+igXL2MklrQiyZmUO21oezrFtVCD4LNtjwiXa6\naQN5jzDv1JGDcEFQjxOMotgvxc6sFcwFisHe0mA52kH80+HGXk/me6EKT+fRZBMX\nHJNNSnBa9wKBgQCDC0WUmNHmbPF43qxT0RuNASMobl055zndwZz8Ok5zwfuIlE/2\n10991hxQmVTzgk6Cxq5A3bAJgQCa2aPUgDJsse9YAZAM8qQsTbmDAnHjh0BuVLl3\neLr4InlP3jN6eJe9i8kZBLohfeFMI/CgAqjmopJWQEa2A+usJig9CZwW8QKBgBNU\nf7+CmJGDk9Y1M/jjXJ8NTMO2iNhU1wR812ElME47d13MrSWn9W5oCfc1kQW7K0Pz\nSf0we9Jgvk8uCh0SKNQ1K8McKP0lNsX3ed3WhzyMMaGTN6P1hRDWIVsrytu+01JL\n6PyHlmbKiIiFMGvWg7ImaDraufLX0MdYNs0RiYFXAoGBAN14F+uSIJuziM4TcqhG\nrhbrUvhBXF4vZb0lNS/RumH9SfG3zCfcZHVOwX82UFi2A5SsY2rhSkgbZTBy/cNv\nT29iCfAU6kHtTt5VyNrlQhfvFTZwL63SKhYo3QBQjvSkKP/pgOr+5gfwirkMkf3a\nbzrKmZjDrH2JUMQ8Ef2qlBh2\n-----END PRIVATE KEY-----\n",
            "client_email": "server@server-472112.iam.gserviceaccount.com",
            "client_id": "113111949371572393714",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/server%40server-472112.iam.gserviceaccount.com",
            "universe_domain": "googleapis.com"
          }
          JSON

      - name: Create test file
        run: echo "Hello SIGMA from GitHub Actions ðŸš€" > test.txt

      - name: Upload + Download + List files
        run: |
          python3 - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
          import io

          SERVICE_ACCOUNT_FILE = "service_account.json"
          SCOPES = ["https://www.googleapis.com/auth/drive"]
          FOLDER_ID = "191AWhGPc0j--SFCDnUPSG1sFDCr-CauX"

          creds = service_account.Credentials.from_service_account_file(
              SERVICE_ACCOUNT_FILE, scopes=SCOPES
          )
          drive = build("drive", "v3", credentials=creds)

          # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
          file_metadata = {"name": "test.txt", "parents": [FOLDER_ID]}
          media = MediaFileUpload("test.txt", resumable=True)
          uploaded = drive.files().create(
              body=file_metadata,
              media_body=media,
              fields="id",
              supportsAllDrives=True
          ).execute()
          file_id = uploaded.get("id")
          print("âœ… Uploaded file ID:", file_id)

          # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
          request = drive.files().get_media(fileId=file_id)
          fh = io.FileIO("downloaded_test.txt", "wb")
          downloader = MediaIoBaseDownload(fh, request)
          done = False
          while not done:
              status, done = downloader.next_chunk()
          print("â¬‡ï¸ Downloaded file as downloaded_test.txt")

          # Ù„Ø³ØªØ© ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
          print("\\nðŸ“‚ Files currently in the folder:")
          results = drive.files().list(
              q=f"'{FOLDER_ID}' in parents and trashed=false",
              fields="files(id, name)",
              supportsAllDrives=True,
              includeItemsFromAllDrives=True
          ).execute()
          for f in results.get("files", []):
              print(f"- {f['name']} (ID: {f['id']})")
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded_test
          path: downloaded_test.txt
