name: Minecraft Server Loop

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Set up Java 16
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 16

      - name: Download PaperMC
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      - name: Accept EULA and set server.properties
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" > server.properties

      - name: Run server (5 min then stop)
        run: |
          timeout 5m java -Xmx16G -Xms12G -jar server.jar --nogui || true
          echo "stop" >> server.log

      - name: Save worlds
        run: |
          mkdir -p saved/worlds
          cp -r world world_nether world_the_end saved/worlds/ || true

      - name: Save plugins
        run: |
          mkdir -p saved/plugins
          cp -r plugins/* saved/plugins/ || true

      - name: Save configs and properties
        run: |
          mkdir -p saved/config
          cp eula.txt server.properties saved/config/ || true

      - name: Commit & Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add saved/ || true
          git commit -m "⏺️ Auto-save worlds, plugins, and configs" || true
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/AhmedGER/Server.git
          git push origin HEAD:main

      - name: Relaunch workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "♻️ Relaunching workflow..."
          echo $'machine github.com\n  login $GITHUB_TOKEN' > ~/.netrc
          gh workflow run "Minecraft Server Loop" --repo AhmedGER/Server
