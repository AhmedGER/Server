name: Minecraft Server Test

on:
  workflow_dispatch:  # تشغيل يدوي

jobs:
  run-server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java 16
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 16

      - name: Install expect
        run: sudo apt-get update && sudo apt-get install -y expect

      - name: Run server with auto-stop after 15 minutes
        run: |
          cat > run-server.exp <<'EOF'
          #!/usr/bin/expect -f
          set timeout 900        ;# 900 ثانية = 15 دقيقة
          spawn java -Xmx16G -Xms12G -jar server.jar --nogui
          expect {
            timeout { send "stop\r" }
          }
          expect eof
          EOF
          chmod +x run-server.exp
          ./run-server.exp

      # 🟢 حفظ العوالم
      - name: Upload Worlds
        uses: actions/upload-artifact@v4
        with:
          name: worlds-backup
          path: |
            world
            world_nether
            world_the_end

      # 🟢 حفظ الـ Plugins
      - name: Upload Plugins
        uses: actions/upload-artifact@v4
        with:
          name: plugins-backup
          path: plugins

      # 🟢 حفظ ملفات تانية مهمة (configs, logs, إلخ)
      - name: Upload Configs and Logs
        uses: actions/upload-artifact@v4
        with:
          name: configs-logs-backup
          path: |
            server.properties
            bukkit.yml
            spigot.yml
            paper.yml
            logs
