name: Test Google Service Account

on:
  workflow_dispatch:

jobs:
  test-service-account:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3

      # 1️⃣ تأكد أن الملف موجود
      - name: 🔍 Step 1 - Check if service_account.json exists
        run: |
          if [ -f "service_account.json" ]; then
            echo "✅ service_account.json found!"
            ls -l service_account.json
          else
            echo "❌ service_account.json not found!"
            exit 1
          fi

      # 2️⃣ اطبع الـ private_key بالكامل
      - name: 🔑 Step 2 - Print private key
        run: |
          echo "🔑 Extracting private_key..."
          python3 - <<'PY'
          import json
          with open("service_account.json") as f:
              data = json.load(f)
          print("✅ private_key:")
          print(data["private_key"])
          PY

      # 3️⃣ تحقق أن JSON سليم
      - name: ✅ Step 3 - Validate JSON structure
        run: |
          python3 - <<'PY'
          import json
          try:
              with open("service_account.json") as f:
                  data = json.load(f)
              print("✅ JSON loaded successfully")
              print("client_email:", data.get("client_email"))
              print("project_id:", data.get("project_id"))
          except Exception as e:
              print("❌ JSON Error:", e)
              exit(1)
          PY

      # 4️⃣ جرب الاتصال بـ Google
      - name: 🌍 Step 4 - Authenticate with Google
        run: |
          pip install google-auth google-auth-oauthlib google-api-python-client
          python3 - <<'PY'
          from google.oauth2 import service_account
          creds = service_account.Credentials.from_service_account_file(
              "service_account.json",
              scopes=["https://www.googleapis.com/auth/drive.metadata.readonly"],
          )
          print("✅ Authenticated, Service Account:", creds.service_account_email)
          PY

      # 5️⃣ اقرأ الملفات من Google Drive
      - name: 📂 Step 5 - List Google Drive files
        run: |
          python3 - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          creds = service_account.Credentials.from_service_account_file(
              "service_account.json",
              scopes=["https://www.googleapis.com/auth/drive.metadata.readonly"],
          )
          service = build("drive", "v3", credentials=creds)
          results = service.files().list(pageSize=5, fields="files(id, name)").execute()
          items = results.get("files", [])
          if not items:
              print("❌ No files found.")
          else:
              print("✅ Files found in Drive:")
              for item in items:
                  print(f"- {item['name']} ({item['id']})")
          PY
