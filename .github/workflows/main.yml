name: Minecraft Server

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */5 * * *"   # يبدأ كل 5 ساعات

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      # --- Checkout repo ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Install Java 16 ---
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 16

      # --- Download PaperMC (server.jar) ---
      - name: Download PaperMC
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      # --- Accept EULA + إعدادات السيرفر ---
      - name: Setup server files
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" >> server.properties
          mkdir -p plugins
          # تحميل playit plugin
          curl -L -o plugins/playit-minecraft-plugin.jar https://github.com/playit-cloud/playit-minecraft-plugin/releases/download/v0.1.4/playit-minecraft-plugin-1.16.jar

      # --- Start server with auto-restart loop ---
      - name: Run server
        run: |
          echo '#!/bin/bash' > run-server.sh
          echo 'for i in {1..1}' >> run-server.sh
          echo 'do' >> run-server.sh
          echo '  java -Xmx16G -Xms12G -jar server.jar --nogui' >> run-server.sh
          echo 'done' >> run-server.sh
          chmod +x run-server.sh
          timeout 5h ./run-server.sh

      # --- Save world & plugins to repo ---
      - name: Save server data
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          mkdir -p backup
          cp -r world world_nether world_the_end plugins server.properties eula.txt backup/ || true
          git add backup
          git commit -m "Auto backup at $(date)" || echo "No changes to commit"
          git push
