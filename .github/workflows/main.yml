name: Google Drive Service Account Test

on:
  workflow_dispatch:

jobs:
  test-drive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python Google API client
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Create service_account.json
        run: |
          cat > service_account.json <<'JSON'
          {
            "type": "service_account",
            "project_id": "server-472112",
            "private_key_id": "fb0ef84bf8e4d48004641d0a4b5d239e14102ea0",
            "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCmNvhMcLykkaVs\n...\n-----END PRIVATE KEY-----\n",
            "client_email": "server@server-472112.iam.gserviceaccount.com",
            "client_id": "113111949371572393714",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/server%40server-472112.iam.gserviceaccount.com",
            "universe_domain": "googleapis.com"
          }
          JSON

      - name: Create test file
        run: echo "Hello SIGMA from GitHub Actions ðŸš€" > test.txt

      - name: Upload + Download + List files
        run: |
          python3 - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
          import io

          SERVICE_ACCOUNT_FILE = "service_account.json"
          SCOPES = ["https://www.googleapis.com/auth/drive"]
          FOLDER_ID = "191AWhGPc0j--SFCDnUPSG1sFDCr-CauX"

          creds = service_account.Credentials.from_service_account_file(
              SERVICE_ACCOUNT_FILE, scopes=SCOPES
          )
          drive = build("drive", "v3", credentials=creds)

          # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
          file_metadata = {"name": "test.txt", "parents": [FOLDER_ID]}
          media = MediaFileUpload("test.txt", resumable=True)
          uploaded = drive.files().create(
              body=file_metadata,
              media_body=media,
              fields="id",
              supportsAllDrives=True
          ).execute()
          file_id = uploaded.get("id")
          print("âœ… Uploaded file ID:", file_id)

          # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
          request = drive.files().get_media(fileId=file_id)
          fh = io.FileIO("downloaded_test.txt", "wb")
          downloader = MediaIoBaseDownload(fh, request)
          done = False
          while not done:
              status, done = downloader.next_chunk()
          print("â¬‡ï¸ Downloaded file as downloaded_test.txt")

          # Ù„Ø³ØªØ© ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
          print("\\nðŸ“‚ Files currently in the folder:")
          results = drive.files().list(
              q=f"'{FOLDER_ID}' in parents and trashed=false",
              fields="files(id, name)",
              supportsAllDrives=True,
              includeItemsFromAllDrives=True
          ).execute()
          for f in results.get("files", []):
              print(f"- {f['name']} (ID: {f['id']})")
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded_test
          path: downloaded_test.txt
