name: Minecraft Server Loop to Google Drive

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java 16
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 16

      - name: Download PaperMC
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      - name: Accept EULA and set server.properties
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" > server.properties

      - name: Run server (5 min then stop)
        run: |
          timeout 5m java -Xmx16G -Xms12G -jar server.jar --nogui || true
          echo "stop" >> server.log

      - name: Save worlds
        run: |
          mkdir -p saved/world
          cp -r world/* saved/world/ || true
          mkdir -p saved/world_nether
          cp -r world_nether/* saved/world_nether/ || true
          mkdir -p saved/world_the_end
          cp -r world_the_end/* saved/world_the_end/ || true

      - name: Save plugins
        run: |
          mkdir -p saved/plugins
          cp -r plugins/* saved/plugins/ || true

      - name: Save configs and properties
        run: |
          mkdir -p saved/config
          cp eula.txt server.properties saved/config/ || true

      - name: Install Python & PyDrive
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install PyDrive

      - name: Create upload script for Google Drive
        run: |
          cat << 'EOF' > upload_drive.py
          from pydrive.auth import GoogleAuth
          from pydrive.drive import GoogleDrive
          import os

          gauth = GoogleAuth()
          gauth.CLIENT_ID = "1075710372669-okh2fruq84qdqdrn8ir2dke8cm5sth5o.apps.googleusercontent.com"
          gauth.CLIENT_SECRET = "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"
          gauth.LocalWebserverAuth()  # لأول مرة هيفتح صفحة تسجيل دخول
          drive = GoogleDrive(gauth)

          local_folder = "saved/"
          drive_folder_id = "191AWhGPc0j--SFCDnUPSG1sFDCr-CauX"

          def create_drive_folder(name, parent_id):
              folder_list = drive.ListFile({'q': f"title='{name}' and '{parent_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"}).GetList()
              if folder_list:
                  return folder_list[0]['id']
              folder_metadata = {'title': name, 'mimeType': 'application/vnd.google-apps.folder', 'parents':[{'id': parent_id}]}
              folder = drive.CreateFile(folder_metadata)
              folder.Upload()
              return folder['id']

          for item in os.listdir(local_folder):
              item_path = os.path.join(local_folder, item)
              if os.path.isdir(item_path):
                  drive_subfolder_id = create_drive_folder(item, drive_folder_id)
                  for root, dirs, files in os.walk(item_path):
                      for file in files:
                          file_path = os.path.join(root, file)
                          rel_path = os.path.relpath(file_path, item_path)
                          f = drive.CreateFile({'title': rel_path, 'parents':[{'id': drive_subfolder_id}]})
                          f.SetContentFile(file_path)
                          f.Upload()
                          print(f"✅ تم رفع {item}/{rel_path}")
              elif os.path.isfile(item_path):
                  f = drive.CreateFile({'title': item, 'parents':[{'id': drive_folder_id}]})
                  f.SetContentFile(item_path)
                  f.Upload()
                  print(f"✅ تم رفع {item}")
          EOF

      - name: Upload saved data to Google Drive
        run: |
          python3 upload_drive.py
