name: Test Google Service Account

on:
  workflow_dispatch:

jobs:
  test-service-account:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3

      # 1ï¸âƒ£ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯
      - name: ğŸ” Step 1 - Check if service_account.json exists
        run: |
          if [ -f "service_account.json" ]; then
            echo "âœ… service_account.json found!"
            ls -l service_account.json
          else
            echo "âŒ service_account.json not found!"
            exit 1
          fi

      # 2ï¸âƒ£ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ù€ private_key Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      - name: ğŸ”‘ Step 2 - Print private key
        run: |
          echo "ğŸ”‘ Extracting private_key..."
          python3 - <<'PY'
          import json
          with open("service_account.json") as f:
              data = json.load(f)
          print("âœ… private_key:")
          print(data["private_key"])
          PY

      # 3ï¸âƒ£ ØªØ­Ù‚Ù‚ Ø£Ù† JSON Ø³Ù„ÙŠÙ…
      - name: âœ… Step 3 - Validate JSON structure
        run: |
          python3 - <<'PY'
          import json
          try:
              with open("service_account.json") as f:
                  data = json.load(f)
              print("âœ… JSON loaded successfully")
              print("client_email:", data.get("client_email"))
              print("project_id:", data.get("project_id"))
          except Exception as e:
              print("âŒ JSON Error:", e)
              exit(1)
          PY

      # 4ï¸âƒ£ Ø¬Ø±Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google
      - name: ğŸŒ Step 4 - Authenticate with Google
        run: |
          pip install google-auth google-auth-oauthlib google-api-python-client
          python3 - <<'PY'
          from google.oauth2 import service_account
          creds = service_account.Credentials.from_service_account_file(
              "service_account.json",
              scopes=["https://www.googleapis.com/auth/drive.metadata.readonly"],
          )
          print("âœ… Authenticated, Service Account:", creds.service_account_email)
          PY

      # 5ï¸âƒ£ Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Google Drive
      - name: ğŸ“‚ Step 5 - List Google Drive files
        run: |
          python3 - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          creds = service_account.Credentials.from_service_account_file(
              "service_account.json",
              scopes=["https://www.googleapis.com/auth/drive.metadata.readonly"],
          )
          service = build("drive", "v3", credentials=creds)
          results = service.files().list(pageSize=5, fields="files(id, name)").execute()
          items = results.get("files", [])
          if not items:
              print("âŒ No files found.")
          else:
              print("âœ… Files found in Drive:")
              for item in items:
                  print(f"- {item['name']} ({item['id']})")
          PY
