name: Test Google Drive Connection

on:
  workflow_dispatch:

jobs:
  test-drive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Validate service_account.json
        run: |
          echo "üîç Checking JSON structure..."
          python3 - <<'PY'
          import json
          try:
              with open("service_account.json") as f:
                  data = json.load(f)
              print("‚úÖ JSON loaded successfully")
              print("client_email:", data.get("client_email"))
              print("project_id:", data.get("project_id"))
          except Exception as e:
              print("‚ùå JSON Error:", e)
              exit(1)
          PY

      - name: Test Google Drive Access
        run: |
          echo "üåê Connecting to Google Drive..."
          python3 - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          SCOPES = ["https://www.googleapis.com/auth/drive.metadata.readonly"]
          creds = service_account.Credentials.from_service_account_file(
              "service_account.json", scopes=SCOPES
          )
          service = build("drive", "v3", credentials=creds)

          results = service.files().list(pageSize=5, fields="files(id, name)").execute()
          items = results.get("files", [])

          if not items:
              print("‚ö†Ô∏è No files found.")
          else:
              print("‚úÖ Files from Google Drive:")
              for item in items:
                  print(f" - {item['name']} ({item['id']})")
          PY
