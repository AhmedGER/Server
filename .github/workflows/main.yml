name: Minecraft Server

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # ÙŠØ¹Ù…Ù„ restart ÙƒÙ„ Ø³Ø§Ø¹Ø©

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1- Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      # 2- Setup Git user (Ø¹Ù„Ø´Ø§Ù† Ù†Ø¹Ù…Ù„ push Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª)
      - name: Setup Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      # 3- Setup Java 16
      - name: Setup Java 16
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '16'

      # 4- Download Paper 1.16.5
      - name: Download PaperMC
        run: |
          mkdir -p server
          cd server
          if [ ! -f server.jar ]; then
            curl -L -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar
          fi

      # 5- Setup configs + plugins (include Playit)
      - name: Setup server configs and plugins
        run: |
          cd server
          echo "eula=true" > eula.txt
          echo "online-mode=false" > server.properties
          echo "motd=Sigma's GitHub Server" >> server.properties
          echo "max-players=20" >> server.properties

          # Ø§Ù†Ø³Ø® Ø§Ù„Ù€ plugins Ù…Ù† repo Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
          mkdir -p plugins
          cp -r ../plugins/* ./plugins/ || true

          # Ù†Ø²Ù‘Ù„ Playit plugin ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          curl -L -o plugins/playit-minecraft-plugin-1.16.jar https://github.com/playit-cloud/playit-minecraft-plugin/releases/download/v0.1.4/playit-minecraft-plugin-1.16.jar

      # 6- Run Minecraft Server with autorestart
      - name: Run Minecraft Server
        run: |
          cd server
          while true; do
            echo "ðŸš€ Starting Minecraft server..."
            java -Xmx16G -Xms12G -jar server.jar --nogui
            echo "ðŸ”„ Restarting in 60 minutes..."
            sleep 3600
          done

      # 7- Save world + configs + plugins
      - name: Save server data
        if: always()
        run: |
          cd server
          cp -r world ../world || true
          cp -r world_nether ../world_nether || true
          cp -r world_the_end ../world_the_end || true
          cp -r plugins ../plugins || true
          cp server.properties ../ || true
          cp eula.txt ../ || true

          cd ..
          git add .
          git commit -m "Auto-save server data & plugins [skip ci]" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
