name: Minecraft Server Loop

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java 16
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 16

      - name: Download PaperMC
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      - name: Accept EULA and set server.properties
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" > server.properties

      - name: Run server (5 min then stop)
        run: |
          timeout 5m java -Xmx16G -Xms12G -jar server.jar --nogui || true
          echo "stop" >> server.log

      # ğŸ—‚ï¸ Ø­ÙØ¸ Ø§Ù„Ø¹ÙˆØ§Ù„Ù…
      - name: Save worlds
        run: |
          mkdir -p saved/worlds
          cp -r world world_nether world_the_end saved/worlds/ || true

      # ğŸ› ï¸ Ø­ÙØ¸ Ø§Ù„Ù€ Plugins
      - name: Save plugins
        run: |
          mkdir -p saved/plugins
          cp -r plugins/* saved/plugins/ || true

      # ğŸ“¦ Ø­ÙØ¸ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ù…Ù‡Ù…Ø© ØªØ§Ù†ÙŠØ©
      - name: Save configs and properties
        run: |
          mkdir -p saved/config
          cp eula.txt server.properties saved/config/ || true

      # ğŸ”¼ Push Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      - name: Commit & Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add saved/ || true
          git commit -m "âºï¸ Auto-save worlds, plugins, and configs" || true
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/AhmedGER/Server.git HEAD:main

      # ğŸ” Relaunch workflow
      - name: Relaunch workflow
        run: |
          echo "â™»ï¸ Relaunching workflow..."
          gh workflow run "Minecraft Server Loop"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
