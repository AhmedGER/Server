name: Minecraft Server Loop

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Java 16
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 16

      # 3Ô∏è‚É£ Download Paper
      - name: Download Paper 1.16.5
        run: |
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.16.5/builds/794/downloads/paper-1.16.5-794.jar

      # 4Ô∏è‚É£ Accept EULA & configure properties
      - name: Configure Server Files
        run: |
          echo "eula=true" > eula.txt
          echo "online-mode=false" >> server.properties
          echo "max-players=20" >> server.properties
          echo "motd=SIGMA Server" >> server.properties

      # 5Ô∏è‚É£ Run server (15 min then stop)
      - name: Run Server
        run: |
          timeout 15m bash -c "java -Xmx16G -Xms12G -jar server.jar --nogui" || true

      # 6Ô∏è‚É£ Save Worlds
      - name: Save Worlds
        run: |
          mkdir -p saved/worlds
          cp -r world* saved/worlds/ || true

      # 7Ô∏è‚É£ Save Plugins
      - name: Save Plugins
        run: |
          mkdir -p saved/plugins
          cp -r plugins/* saved/plugins/ || true

      # 8Ô∏è‚É£ Save Other important files
      - name: Save Configs and Properties
        run: |
          mkdir -p saved/configs
          cp eula.txt server.properties saved/configs/ || true

      # 9Ô∏è‚É£ Commit & Push changes
      - name: Commit & Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add saved/*
          git commit -m "Auto-save server data"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # üîÅ Relaunch Workflow
      - name: Relaunch Workflow
        run: |
          echo "‚ôªÔ∏è Relaunching workflow..."
          gh workflow run "Minecraft Server Loop"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
